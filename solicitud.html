<!doctype html><html lang='es'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Nueva Requisición</title><link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'><style>body{background:#f4f6f8;font-family:Inter,Segoe UI,system-ui}.card{border-radius:12px}.logo{max-width:110px}.product-row{background:#fff;padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid #eef2f5}</style></head><body><nav class='navbar navbar-light bg-white shadow-sm'><div class='container'><a class='navbar-brand' href='#'><img src='{{ url_for('static', filename='logo.png') }}' style='height:34px' class='me-2'> Requisiciones LBP</a><div class='d-flex gap-2'><a class='btn btn-outline-secondary btn-sm' href='/mis_requisiciones'>Mis requisiciones</a><a class='btn btn-outline-dark btn-sm' href='/autorizar'>Autorizaciones</a><a class='btn btn-outline-danger btn-sm' href='/logout'>Salir</a></div></div></nav><div class='container mt-4'><div class='card p-4'><div class='d-flex align-items-center mb-3'><img src='{{ url_for('static', filename='logo.png') }}' class='logo me-3'><div><h4 class='mb-0'>Crear requisición</h4><small class='text-muted'>Agregar uno o varios productos</small></div></div>{% if success %}<div class='alert alert-success'>{{ success }}</div>{% endif %}<form method='post' enctype='multipart/form-data' id='reqForm'><div class='row g-3 mb-3'><div class='col-md-4'><label class='form-label'>Departamento</label><select id='departamento' name='departamento' class='form-select' required>{% for d in departments %}<option value='{{d}}'>{{d}}</option>{% endfor %}</select></div><div class='col-md-4'><label class='form-label'>Etapa</label><select id='etapa' name='etapa' class='form-select' required></select></div><div class='col-md-4'><label class='form-label'>Proyecto</label><select id='proyecto' name='proyecto' class='form-select' required></select></div><div class='col-md-6'><label class='form-label'>Ubicación / Rancho</label><select name='ubicacion' class='form-select' required>{% for l in locations %}<option value='{{l}}'>{{l}}</option>{% endfor %}</select></div><div class='col-md-6'><label class='form-label'>Motivo</label><input name='motivo' class='form-control'></div></div><hr><div id='productsContainer'></div><div class='d-flex justify-content-between align-items-center mb-3'><button type='button' id='addProduct' class='btn btn-outline-primary'>+ Agregar producto</button><div class='legend-contact text-muted'>Si el producto no aparece en el catálogo, favor de contactar al área de Compras para su inclusión.</div></div><input type='hidden' name='products_json' id='products_json'><input type='hidden' name='units_json' id='units_json'><input type='hidden' name='qty_json' id='qty_json'><div class='text-end'><button class='btn btn-success' style='border-radius:8px;padding:10px 18px'>Enviar requisición</button></div></form></div></div><script>const stages = {{ stages|tojson }}; const projects_by_dept = {{ projects_by_dept|tojson }}; const products_catalog = {{ products|tojson }}; const units = {{ units|tojson }}; function loadStages(dep){ const etapaSel=document.getElementById('etapa'); etapaSel.innerHTML=''; (stages[dep]||[]).forEach(s=>{let o=document.createElement('option');o.value=s;o.textContent=s;etapaSel.appendChild(o)});} function loadProjects(dep){ const psel=document.getElementById('proyecto'); psel.innerHTML=''; (projects_by_dept[dep]||[]).forEach(p=>{let o=document.createElement('option');o.value=p;o.textContent=p;psel.appendChild(o)});} document.addEventListener('DOMContentLoaded', ()=>{ const dep=document.getElementById('departamento').value; loadStages(dep); loadProjects(dep); document.getElementById('departamento').addEventListener('change',(e)=>{ loadStages(e.target.value); loadProjects(e.target.value); }); let idx=0; function addRow(prefill){ const container=document.getElementById('productsContainer'); const row=document.createElement('div'); row.className='product-row'; row.dataset.index=idx; row.innerHTML=`<div class='row g-2 align-items-end'><div class='col-md-5'><label class='form-label'>Producto</label><select class='form-select prod-select' name='product_${idx}' required><option value=''>-- Seleccione --</option>${products_catalog.map(p=>`<option value="${p}">${p}</option>`).join('')}</select></div><div class='col-md-2'><label class='form-label'>Unidad</label><select class='form-select unit-select' name='unit_${idx}' required>${units.map(u=>`<option value="${u}">${u}</option>`).join('')}</select></div><div class='col-md-2'><label class='form-label'>Cantidad</label><input type='number' class='form-control qty-input' name='qty_${idx}' required></div><div class='col-md-3'><label class='form-label'>Imagen (opcional)</label><input type='file' class='form-control img-input' name='image_${idx}' accept='image/*'></div></div><div class='text-end mt-2'><button type='button' class='btn btn-sm btn-outline-danger remove-btn'>Eliminar</button></div>`; container.appendChild(row); row.querySelector('.remove-btn').addEventListener('click',()=>{row.remove();}); idx++; } addRow(); document.getElementById('addProduct').addEventListener('click',()=>addRow()); document.getElementById('reqForm').addEventListener('submit', function(e){ const prods=[...document.querySelectorAll('.prod-select')].map(s=>s.value); const unitsArr=[...document.querySelectorAll('.unit-select')].map(s=>s.value); const qtys=[...document.querySelectorAll('.qty-input')].map(s=>s.value); document.getElementById('products_json').value=JSON.stringify(prods); document.getElementById('units_json').value=JSON.stringify(unitsArr); document.getElementById('qty_json').value=JSON.stringify(qtys); }); });</script></body></html>